	<?php if ($this->editavel): ?>
		<style>
			.dz-message {
				font-size: 1rem;
				color: #6c757d;
			}

			.upload-box {
				border: 2px dashed #6c757d;
				border-radius: .5rem;
				background: #f8f9fa;
			}
		</style>
	<?php endif; ?>

	<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pb-2 mb-3 border-bottom">
		<h1 class="h2 text-info">Tratativa</h1>
		<div class="btn-toolbar mb-2 mb-md-0">
			<div class="btn-group mr-2">
				<button type="button" onclick="carregarTela('../../kanban')" class="btn btn-primary"><i class="fa fa-arrow-left" aria-hidden="true"></i> Voltar</button>
			</div>
		</div>
	</div>
	<div class="">
		<?php
		$envio = $this->envio;
		include('respostas.php');
		?>
	</div>

	<div class="">
		<?php
		$historico = $this->historico;
		//print_r($historico);die();
		$liberado_interno = true;
		include('historico.php');
		?>
	</div>

	<?php if ($this->editavel): ?>
		<div class="card">
			<div class="card-header" style="background-color:<?= $this->registro['cor'] ?> !important;color:#fff">
				<h2><?= $this->registro['tipo_tarefa'] ?></h2>
			</div>
			<div class="card-body" style="--base:<?= $this->registro['cor'] ?>; --pct:30%; background:color-mix(in srgb, var(--base) var(--pct), white); !important">
				<form id="formulario_tarefa">
					<input name="id_tarefa" type="hidden" value="<?= $this->registro['id_tarefa'] ?>" id="id_tarefa">
					<div class="row">
						<div class="form-group col-md-12">
							<span><label for="nome">Comentário: </label></span>
							<textarea required class="form-control" id="comentario" name="comentario" rows="5"></textarea>
						</div>
					</div>

					<div class="row">
						<div class="form-group col-md-12">
							<label class="checkbox-inline">
								<input type="checkbox" id="chk_comentario_interno">
								Adicionar comentário interno
							</label>
						</div>

						<div class="form-group col-md-12" id="grupo_comentario_interno" style="display:none;">
							<label for="comentario_interno">Comentário Interno:</label>
							<textarea class="form-control" id="comentario_interno" name="comentario_interno" rows="5"></textarea>
						</div>
					</div>

					<? if ($this->proximos_passos): ?>
						<div class="row">
							<div class="form-group col-md-12">
								<span><label for="nome">Status: </label></span>
								<select required class="form-control" name="id_proximo_passo" id="id_proximo_passo">
									<? if (count($this->proximos_passos) > 0) foreach ($this->proximos_passos as $key => $value): ?>
										<option value="<?= $key ?>"><?= $value['nome'] ?></option>
									<? endforeach; ?>
								</select>
							</div>
						</div>
					<? endif; ?>

				</form>

				<div class="row">
					<div class="form-group col-12">
						<span><label for="meuDropzone">Anexos: </label></span>

						<!-- Form Dropzone -->
						<form action="upload.php" class="dropzone upload-box" id="meuDropzone">
							<div class="dz-message p-4">
								Arraste arquivos aqui ou <span class="text-primary">clique para selecionar</span><br>
								<small class="text-muted">Formatos permitidos: JPG, PNG, PDF • Máx <?= Tarefa::$max_size_file ?> MB por arquivo</small>
							</div>
						</form>

						<div class="mt-3 d-flex align-items-center">
							<button id="btnLimpar" class="btn btn-outline-secondary">Limpar</button>
						</div>
					</div>
				</div>

				<div class="row">
					<div class="form-group col-12 text-right">
						<button class="btn btn-success salvar" id="salvar_tarefa"><span class="glyphicon glyphicon-floppy-disk"></span><i class="fa fa-floppy-o fa-lg"></i> Salvar</button>
					</div>
				</div>
			</div>
		</div>

	<?php else: ?>
		<div class="card">
			<div class="card-header" style="background-color:<?= $this->registro['cor'] ?> !important;color:#fff">
				<h2><?= $this->registro['tipo_tarefa'] ?></h2>
			</div>
		</div>
	<?php endif; ?>



	<script>
		$(document).ready(function() {

			(function() {
				var chk = document.getElementById('chk_comentario_interno');
				var grp = document.getElementById('grupo_comentario_interno');
				var area = document.getElementById('comentario_interno');

				function toggleComentario() {
					var on = chk.checked;
					grp.style.display = on ? '' : 'none';
					area.required = on; // só exige quando visível
					if (!on) area.value = ''; // opcional: limpa ao esconder
				}

				chk.addEventListener('change', toggleComentario);
				// estado inicial (se quiser iniciar marcado, defina checked no HTML e ele já abre)
				toggleComentario();
			})();
			<?php if ($this->editavel): ?>
				const dz = new Dropzone("#meuDropzone", {
					url: "#", // não será usado (enviamos via AJAX do form)
					autoProcessQueue: false, // importante: não enviar sozinho
					clickable: true,
					addRemoveLinks: true,
					parallelUploads: 10,
					maxFilesize: <?= Tarefa::$max_size_file ?>, // MB
					acceptedFiles: ".jpg,.jpeg,.png,.pdf",
					dictDefaultMessage: "Arraste arquivos aqui ou clique para selecionar",
					dictRemoveFile: "Remover",
					dictCancelUpload: "Cancelar",
					init: function() {
						// opcional: limitar qtd
						// this.options.maxFiles = 10;
					}
				});

				$("#btnLimpar").on("click", function(e) {
					e.preventDefault();
					dz.removeAllFiles(true);
					$("#status").text("Aguardando arquivos…");
				});

				<? if ($this->proximos_passos): ?>
					$('#id_proximo_passo').val('');
				<? endif; ?>

				$('#salvar_tarefa').on('click', function() {
					$("#formulario_tarefa").trigger('submit');
				});

				$("#formulario_tarefa").on('submit', function(e) {
					e.preventDefault();
					const form = this;

					// validação nativa, se quiser
					if (!form.checkValidity()) {
						form.reportValidity();
						return;
					}

					// Monta FormData com campos do formulário
					const fd = new FormData(form);

					// Pega os arquivos do Dropzone
					// getAcceptedFiles() = prontos p/ envio (não rejeitados)
					// getQueuedFiles() também funciona; use acceptedFiles se validar no front
					const files = dz.getAcceptedFiles();

					// Se quiser obrigar 1+ arquivo:
					// if (files.length === 0) { alert("Anexe pelo menos um arquivo."); return; }

					files.forEach((file, i) => {
						// 'arquivos[]' para múltiplos
						fd.append('arquivos[]', file, file.name);
						// Se quiser metadados por arquivo:
						// fd.append(`arquivo_nome_original[${i}]`, file.name);
						// fd.append(`arquivo_tamanho[${i}]`, file.size);
						// fd.append(`arquivo_tipo[${i}]`, file.type);
					});

					// Campos extras (ex.: token CSRF)
					// fd.append('_token', '...');

					$('.salvar').hide();

					$.ajax({
						url: '../../tarefa/salvar',
						method: 'POST',
						data: fd,
						processData: false,
						contentType: false,
						xhr: function() {
							const xhr = $.ajaxSettings.xhr();
							if (xhr.upload) {
								xhr.upload.addEventListener('progress', function(evt) {
									if (evt.lengthComputable) {
										const pct = Math.round((evt.loaded / evt.total) * 100);
										// atualize uma barra de progresso se quiser
										// $('#prog').css('width', pct+'%');
									}
								}, false);
							}
							return xhr;
						},
						beforeSend: function() {
							// desabilitar botão, etc.
						},
						success: function(data) {
							// falha ao salvar
							if (data.trim().length > 0) {
								$('.salvar').show();
								swal({
									title: "Atenção!",
									text: data,
									type: "error"
								});
								// sucesso ao salvar
							} else {
								carregarTela('../../kanban');
							}
						},
						error: function(xhr) {
							swal({
								title: "Atenção!",
								text: 'Erro no envio (' + xhr.status + ').',
								type: "error"
							});
						},
						complete: function() {
							// reabilitar botão, etc.
						}
					});
				});
			<?php endif; ?>
		});
	</script>