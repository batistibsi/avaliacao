<div class="container-fluid py-3 py-md-4">

  <!-- Abas de Navegação -->
  <ul class="nav nav-tabs mb-3" id="tabDashboards" role="tablist">
    <li class="nav-item">
      <a class="nav-link active" id="tab-coletivo" data-toggle="tab"
         href="#pane-coletivo" role="tab" aria-controls="pane-coletivo" aria-selected="true">
        <i class="fas fa-users mr-1"></i> Coletivo (Grupos)
      </a>
    </li>
    <li class="nav-item">
      <a class="nav-link" id="tab-individual" data-toggle="tab"
         href="#pane-individual" role="tab" aria-controls="pane-individual" aria-selected="false">
        <i class="fas fa-user mr-1"></i> Individual (Colaborador)
      </a>
    </li>
  </ul>

  <div class="tab-content" id="tabDashboardsContent">

    <!-- ====================== DASHBOARD COLETIVO ====================== -->
    <div class="tab-pane fade show active" id="pane-coletivo" role="tabpanel" aria-labelledby="tab-coletivo">
      <div class="page-header d-flex flex-wrap justify-content-between align-items-center">
        <div>
          <h4 class="mb-0">Dashboard Coletivo</h4>
          <small>Visão geral das notas por grupo e dimensão.</small>
        </div>
        <div class="d-flex flex-wrap mt-2 mt-md-0">
          <!-- Filtros exemplo -->
          <div class="mr-2 mb-2">
            <label class="small mb-1 font-weight-bold">Período</label>
            <select id="filtroPeriodoColetivo" class="form-control form-control-sm">
              <option value="ult_30">Últimos 30 dias</option>
              <option value="2025-01">Jan/2025</option>
              <option value="2025-02">Fev/2025</option>
              <option value="2025-03">Mar/2025</option>
            </select>
          </div>
          <div class="mr-2 mb-2">
            <label class="small mb-1 font-weight-bold">Grupo</label>
            <select id="filtroGrupoColetivo" class="form-control form-control-sm">
              <option value="todos">Todos</option>
              <option value="1">Atendimento</option>
              <option value="2">Desenvolvimento</option>
              <option value="3">Comercial</option>
            </select>
          </div>
        </div>
      </div>

      <!-- KPIs linha 1 -->
      <div class="row mb-3">
        <div class="col-md-3 mb-3">
          <div class="card card-kpi">
            <div class="card-body">
              <div class="card-kpi-title">Média geral</div>
              <div class="card-kpi-value" id="kpiMediaGeralColetivo">--</div>
              <div class="small text-muted">Notas de 0 a 10 no período selecionado.</div>
            </div>
          </div>
        </div>
        <div class="col-md-3 mb-3">
          <div class="card card-kpi">
            <div class="card-body">
              <div class="card-kpi-title">Grupo destaque</div>
              <div class="card-kpi-value" id="kpiMelhorGrupo">--</div>
              <div class="small text-muted">
                <span class="badge badge-soft" id="kpiMelhorGrupoNome">-</span>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-3 mb-3">
          <div class="card card-kpi">
            <div class="card-body">
              <div class="card-kpi-title">Grupo crítico</div>
              <div class="card-kpi-value" id="kpiPiorGrupo">--</div>
              <div class="small text-muted">
                <span class="badge badge-soft" id="kpiPiorGrupoNome">-</span>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-3 mb-3">
          <div class="card card-kpi">
            <div class="card-body">
              <div class="card-kpi-title">Avaliações no período</div>
              <div class="card-kpi-value" id="kpiQtdAvaliacoes">--</div>
              <div class="small text-muted">Total de avaliações registradas.</div>
            </div>
          </div>
        </div>
      </div>

      <!-- Linha de gráficos -->
      <div class="row">
        <!-- Média por grupo -->
        <div class="col-lg-6 mb-3">
          <div class="card">
            <div class="card-header py-2">
              <strong>Média por grupo</strong>
            </div>
            <div class="card-body">
              <div class="chart-container">
                <canvas id="chartMediaPorGrupo"></canvas>
              </div>
            </div>
          </div>
        </div>

        <!-- Média por dimensão -->
        <div class="col-lg-6 mb-3">
          <div class="card">
            <div class="card-header py-2">
              <strong>Média por dimensão</strong>
            </div>
            <div class="card-body">
              <div class="chart-container">
                <canvas id="chartMediaPorDimensao"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Evolução no tempo -->
      <div class="row">
        <div class="col-12 mb-3">
          <div class="card">
            <div class="card-header py-2">
              <strong>Evolução da média geral</strong> <span class="small text-muted">(por mês)</span>
            </div>
            <div class="card-body">
              <div class="chart-container">
                <canvas id="chartEvolucaoGeral"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div>

    <!-- ====================== DASHBOARD INDIVIDUAL ====================== -->
    <div class="tab-pane fade" id="pane-individual" role="tabpanel" aria-labelledby="tab-individual">
      <div class="page-header d-flex flex-wrap justify-content-between align-items-center">
        <div>
          <h4 class="mb-0">Dashboard Individual</h4>
          <small>Visão detalhada das notas de um colaborador.</small>
        </div>
        <div class="d-flex flex-wrap mt-2 mt-md-0">
          <!-- Filtros -->
          <div class="mr-2 mb-2">
            <label class="small mb-1 font-weight-bold mb-0">Colaborador</label>
            <select id="filtroColaboradorIndividual" class="form-control form-control-sm">
              <option value="101">Ana Silva</option>
              <option value="102">Bruno Costa</option>
              <option value="103">Carla Mendes</option>
            </select>
          </div>
          <div class="mr-2 mb-2">
            <label class="small mb-1 font-weight-bold mb-0">Período</label>
            <select id="filtroPeriodoIndividual" class="form-control form-control-sm">
              <option value="ult_90">Últimos 90 dias</option>
              <option value="2025-01">Jan/2025</option>
              <option value="2025-02">Fev/2025</option>
              <option value="2025-03">Mar/2025</option>
            </select>
          </div>
        </div>
      </div>

      <!-- Cabeçalho do colaborador -->
      <div class="row mb-3">
        <div class="col-md-4 mb-3">
          <div class="card card-kpi">
            <div class="card-body d-flex align-items-center">
              <div class="mr-3">
                <div class="rounded-circle d-flex align-items-center justify-content-center"
                     style="width:52px;height:52px;background:#e5e7eb;">
                  <span id="indColabIniciais" class="font-weight-bold">AS</span>
                </div>
              </div>
              <div>
                <div class="card-kpi-title">Colaborador</div>
                <div class="card-kpi-value" style="font-size:1.2rem;" id="indColabNome">Ana Silva</div>
                <div class="small text-muted" id="indColabGrupo">Grupo: Atendimento</div>
              </div>
            </div>
          </div>
        </div>
        <!-- Métricas -->
        <div class="col-md-4 mb-3">
          <div class="card card-kpi">
            <div class="card-body">
              <div class="card-kpi-title">Média do colaborador</div>
              <div class="card-kpi-value" id="indMediaColaborador">--</div>
              <div class="small text-muted">
                <span class="badge badge-soft">Período selecionado</span>
              </div>
            </div>
          </div>
        </div>
        <div class="col-md-4 mb-3">
          <div class="card card-kpi">
            <div class="card-body">
              <div class="card-kpi-title">Média do grupo</div>
              <div class="card-kpi-value" id="indMediaGrupo">--</div>
              <div class="small text-muted">
                Comparação com o grupo atual do colaborador.
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Gráficos -->
      <div class="row">
        <!-- Radar dimensões -->
        <div class="col-lg-6 mb-3">
          <div class="card">
            <div class="card-header py-2">
              <strong>Média por dimensão</strong> <span class="small text-muted">(Colaborador x Grupo)</span>
            </div>
            <div class="card-body">
              <div class="chart-container-small">
                <canvas id="chartRadarDimensoes"></canvas>
              </div>
            </div>
          </div>
        </div>

        <!-- Evolução no tempo -->
        <div class="col-lg-6 mb-3">
          <div class="card">
            <div class="card-header py-2">
              <strong>Evolução no tempo</strong> <span class="small text-muted">(média por ciclo)</span>
            </div>
            <div class="card-body">
              <div class="chart-container-small">
                <canvas id="chartEvolucaoIndividual"></canvas>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Tabela de detalhes (simplificada) -->
      <div class="row">
        <div class="col-12 mb-3">
          <div class="card">
            <div class="card-header py-2 d-flex justify-content-between align-items-center">
              <strong>Detalhes das avaliações</strong>
              <small class="text-muted">Últimas avaliações lançadas.</small>
            </div>
            <div class="card-body p-0">
              <div class="table-responsive">
                <table class="table table-sm table-striped mb-0" id="tabelaAvaliacoesInd">
                  <thead class="thead-light">
                  <tr>
                    <th>Data</th>
                    <th>Dimensão</th>
                    <th>Pergunta</th>
                    <th class="text-center">Nota</th>
                    <th>Gerente</th>
                  </tr>
                  </thead>
                  <tbody>
                  <!-- preenchido via JS -->
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>

    </div><!-- fim tab individual -->

  </div><!-- /.tab-content -->
</div>

<script>
$(function () {

  /* ===================== DADOS DE EXEMPLO (troque por PHP) ===================== */

  // Coletivo – exemplo (aqui você injeta dados reais do PostgreSQL)
  var dadosColetivo = {
    kpis: {
      mediaGeral: 7.8,
      melhorGrupo: { nome: 'Desenvolvimento', media: 8.6 },
      piorGrupo:   { nome: 'Atendimento',    media: 7.1 },
      qtdAvaliacoes: 123
    },
    mediaPorGrupo: {
      labels: ['Atendimento', 'Desenvolvimento', 'Comercial'],
      valores: [7.1, 8.6, 7.9]
    },
    mediaPorDimensao: {
      labels: ['Desempenho', 'Responsabilidade', 'Comunicação', 'Liderança'],
      valores: [8.0, 7.5, 8.2, 7.4]
    },
    evolucaoGeral: {
      labels: ['2025-01', '2025-02', '2025-03', '2025-04'],
      valores: [7.2, 7.6, 7.9, 8.1]
    }
  };

  // Individual – exemplo por colaborador (em produção, traga do backend por AJAX)
  var dadosIndividuais = {
    '101': { // Ana Silva
      nome: 'Ana Silva',
      iniciais: 'AS',
      grupo: 'Atendimento',
      mediaColab: 7.9,
      mediaGrupo: 7.3,
      dimensoes: {
        labels: ['Desempenho', 'Responsabilidade', 'Comunicação', 'Liderança'],
        colab:  [8.2, 7.5, 8.4, 7.2],
        grupo:  [7.9, 7.1, 8.0, 7.0]
      },
      evolucao: {
        labels: ['2025-01', '2025-02', '2025-03', '2025-04'],
        valores: [7.5, 7.8, 8.0, 8.2]
      },
      detalhes: [
        { data: '10/03/2025', dimensao: 'Desempenho',     pergunta: 'Entrega de tarefas no prazo', nota: 9, gerente: 'Carlos' },
        { data: '10/03/2025', dimensao: 'Responsabilidade', pergunta: 'Compromisso com metas',    nota: 8, gerente: 'Carlos' },
        { data: '10/03/2025', dimensao: 'Comunicação',    pergunta: 'Clareza nas interações',    nota: 8, gerente: 'Carlos' }
      ]
    },
    '102': { // Bruno Costa
      nome: 'Bruno Costa',
      iniciais: 'BC',
      grupo: 'Desenvolvimento',
      mediaColab: 8.4,
      mediaGrupo: 8.2,
      dimensoes: {
        labels: ['Desempenho', 'Responsabilidade', 'Comunicação', 'Liderança'],
        colab:  [8.8, 8.5, 7.9, 8.3],
        grupo:  [8.5, 8.0, 7.8, 8.0]
      },
      evolucao: {
        labels: ['2025-01', '2025-02', '2025-03', '2025-04'],
        valores: [8.2, 8.4, 8.5, 8.6]
      },
      detalhes: [
        { data: '05/03/2025', dimensao: 'Desempenho',     pergunta: 'Qualidade do código',        nota: 9, gerente: 'Mariana' },
        { data: '05/03/2025', dimensao: 'Responsabilidade', pergunta: 'Cumprimento de prazos',   nota: 8, gerente: 'Mariana' }
      ]
    },
    '103': { // Carla Mendes
      nome: 'Carla Mendes',
      iniciais: 'CM',
      grupo: 'Comercial',
      mediaColab: 7.2,
      mediaGrupo: 7.8,
      dimensoes: {
        labels: ['Desempenho', 'Responsabilidade', 'Comunicação', 'Liderança'],
        colab:  [7.0, 7.4, 7.8, 6.8],
        grupo:  [7.6, 7.9, 8.1, 7.5]
      },
      evolucao: {
        labels: ['2025-01', '2025-02', '2025-03', '2025-04'],
        valores: [6.9, 7.1, 7.3, 7.4]
      },
      detalhes: [
        { data: '02/03/2025', dimensao: 'Comunicação', pergunta: 'Relacionamento com clientes', nota: 8, gerente: 'Rafael' }
      ]
    }
  };

  /* ========================= CHARTS – INSTÂNCIAS ========================= */

  var chartMediaPorGrupo, chartMediaPorDimensao, chartEvolucaoGeral;
  var chartRadarDimensoes, chartEvolucaoIndividual;

  // Config padrão
  var chartOptionsBase = {
    legend: { display: true },
    responsive: true,
    maintainAspectRatio: false
  };

  function criarChartMediaPorGrupo() {
    var ctx = document.getElementById('chartMediaPorGrupo').getContext('2d');
    chartMediaPorGrupo = new Chart(ctx, {
      type: 'bar',
      data: {
        labels: dadosColetivo.mediaPorGrupo.labels,
        datasets: [{
          label: 'Média por grupo',
          data: dadosColetivo.mediaPorGrupo.valores,
          backgroundColor: 'rgba(59,130,246,0.4)',
          borderColor: 'rgba(59,130,246,1)',
          borderWidth: 1
        }]
      },
      options: $.extend(true, {}, chartOptionsBase, {
        scales: {
          yAxes: [{
            ticks: { min: 0, max: 10, stepSize: 1 }
          }]
        }
      })
    });
  }

  function criarChartMediaPorDimensao() {
    var ctx = document.getElementById('chartMediaPorDimensao').getContext('2d');
    chartMediaPorDimensao = new Chart(ctx, {
      type: 'horizontalBar',
      data: {
        labels: dadosColetivo.mediaPorDimensao.labels,
        datasets: [{
          label: 'Média',
          data: dadosColetivo.mediaPorDimensao.valores,
          backgroundColor: 'rgba(16,185,129,0.4)',
          borderColor: 'rgba(16,185,129,1)',
          borderWidth: 1
        }]
      },
      options: $.extend(true, {}, chartOptionsBase, {
        scales: {
          xAxes: [{
            ticks: { min: 0, max: 10, stepSize: 1 }
          }]
        }
      })
    });
  }

  function criarChartEvolucaoGeral() {
    var ctx = document.getElementById('chartEvolucaoGeral').getContext('2d');
    chartEvolucaoGeral = new Chart(ctx, {
      type: 'line',
      data: {
        labels: dadosColetivo.evolucaoGeral.labels,
        datasets: [{
          label: 'Média geral',
          data: dadosColetivo.evolucaoGeral.valores,
          fill: false,
          borderColor: 'rgba(96,165,250,1)',
          borderWidth: 2,
          pointRadius: 3
        }]
      },
      options: $.extend(true, {}, chartOptionsBase, {
        scales: {
          yAxes: [{
            ticks: { min: 0, max: 10, stepSize: 1 }
          }]
        }
      })
    });
  }

  function criarChartRadarDimensoes(dados) {
    var ctx = document.getElementById('chartRadarDimensoes').getContext('2d');
    chartRadarDimensoes = new Chart(ctx, {
      type: 'radar',
      data: {
        labels: dados.dimensoes.labels,
        datasets: [
          {
            label: 'Colaborador',
            data: dados.dimensoes.colab,
            backgroundColor: 'rgba(59,130,246,0.2)',
            borderColor: 'rgba(59,130,246,1)',
            pointBackgroundColor: 'rgba(59,130,246,1)'
          },
          {
            label: 'Grupo',
            data: dados.dimensoes.grupo,
            backgroundColor: 'rgba(16,185,129,0.2)',
            borderColor: 'rgba(16,185,129,1)',
            pointBackgroundColor: 'rgba(16,185,129,1)'
          }
        ]
      },
      options: $.extend(true, {}, chartOptionsBase, {
        scale: {
          ticks: { min: 0, max: 10, stepSize: 1 }
        }
      })
    });
  }

  function criarChartEvolucaoIndividual(dados) {
    var ctx = document.getElementById('chartEvolucaoIndividual').getContext('2d');
    chartEvolucaoIndividual = new Chart(ctx, {
      type: 'line',
      data: {
        labels: dados.evolucao.labels,
        datasets: [{
          label: 'Média do colaborador',
          data: dados.evolucao.valores,
          fill: false,
          borderColor: 'rgba(234,88,12,1)',
          borderWidth: 2,
          pointRadius: 3
        }]
      },
      options: $.extend(true, {}, chartOptionsBase, {
        scales: {
          yAxes: [{
            ticks: { min: 0, max: 10, stepSize: 1 }
          }]
        }
      })
    });
  }

  /* ========================= COLETIVO – INICIALIZAÇÃO ========================= */

  function atualizarKpisColetivo() {
    $('#kpiMediaGeralColetivo').text(dadosColetivo.kpis.mediaGeral.toFixed(1));
    $('#kpiMelhorGrupo').text(dadosColetivo.kpis.melhorGrupo.media.toFixed(1));
    $('#kpiMelhorGrupoNome').text(dadosColetivo.kpis.melhorGrupo.nome);
    $('#kpiPiorGrupo').text(dadosColetivo.kpis.piorGrupo.media.toFixed(1));
    $('#kpiPiorGrupoNome').text(dadosColetivo.kpis.piorGrupo.nome);
    $('#kpiQtdAvaliacoes').text(dadosColetivo.kpis.qtdAvaliacoes);
  }

  function initDashboardColetivo() {
    atualizarKpisColetivo();
    criarChartMediaPorGrupo();
    criarChartMediaPorDimensao();
    criarChartEvolucaoGeral();
  }

  // Filtros – aqui você chamaria AJAX para recarregar dadosColetivo
  $('#filtroPeriodoColetivo, #filtroGrupoColetivo').on('change', function () {
    // Em produção:
    // 1) Faz $.getJSON('/api/dashboard/coletivo', { periodo: ..., grupo: ... })
    // 2) Atualiza dadosColetivo
    // 3) chama atualizarKpisColetivo() + atualiza os dados dos charts
    console.log('Troca de filtro coletivo (mock)');
  });

  /* ======================== INDIVIDUAL – INICIALIZAÇÃO ======================== */

  function preencherCabecalhoIndividual(dados) {
    $('#indColabNome').text(dados.nome);
    $('#indColabIniciais').text(dados.iniciais);
    $('#indColabGrupo').text('Grupo: ' + dados.grupo);
    $('#indMediaColaborador').text(dados.mediaColab.toFixed(1));
    $('#indMediaGrupo').text(dados.mediaGrupo.toFixed(1));
  }

  function preencherTabelaIndividual(dados) {
    var $tbody = $('#tabelaAvaliacoesInd tbody');
    $tbody.empty();
    dados.detalhes.forEach(function (linha) {
      var tr = '<tr>' +
        '<td>' + linha.data + '</td>' +
        '<td>' + linha.dimensao + '</td>' +
        '<td>' + linha.pergunta + '</td>' +
        '<td class="text-center">' + linha.nota + '</td>' +
        '<td>' + linha.gerente + '</td>' +
        '</tr>';
      $tbody.append(tr);
    });
  }

  function carregarDashboardIndividual() {
    var id = $('#filtroColaboradorIndividual').val();
    var dados = dadosIndividuais[id];
    if (!dados) return;

    preencherCabecalhoIndividual(dados);
    preencherTabelaIndividual(dados);

    // Destroi gráficos antigos se existirem
    if (chartRadarDimensoes) chartRadarDimensoes.destroy();
    if (chartEvolucaoIndividual) chartEvolucaoIndividual.destroy();

    criarChartRadarDimensoes(dados);
    criarChartEvolucaoIndividual(dados);
  }

  $('#filtroColaboradorIndividual, #filtroPeriodoIndividual').on('change', function () {
    // Em produção, você pode usar o período para buscar dados específicos no backend
    carregarDashboardIndividual();
  });

  /* ======================== INICIALIZAÇÃO GERAL ======================== */

  // Coletivo logo ao carregar
  initDashboardColetivo();

  // Individual – carrega quando a aba é exibida pela primeira vez
  $('a[data-toggle="tab"][href="#pane-individual"]').on('shown.bs.tab', function () {
    carregarDashboardIndividual();
  });

});
</script>