<!-- ====================== DASHBOARD INDIVIDUAL ====================== -->
<!-- Cabeçalho do colaborador -->
<div class="row mb-3">
  <div class="col-md-4 mb-3">
    <div class="card p-1 card-kpi bg-light">
      <div class="card-body d-flex align-items-center">
        <div class="mr-3">
          <div class="rounded-circle d-flex align-items-center justify-content-center bg-info text-white"
            style="width:52px;height:52px;">
            <span id="indColabIniciais" class="font-weight-bold"><?= Util::gerarIniciais($this->usuario['nome']) ?></span>
          </div>
        </div>
        <div>
          <div class="card-kpi-title">Colaborador</div>
          <div class="card-kpi-value text-primary" style="font-size:1.2rem;" id="indColabNome"><?= $this->usuario['nome'] ?></div>
          <div class="small text-muted" id="indColabGrupo">Grupo: <?= $this->usuario['grupo'] ?></div>
        </div>
      </div>
    </div>
  </div>
  <!-- Métricas -->
  <div class="col-md-4 mb-3">
    <div class="card card-kpi">
      <div class="card-body">
        <div class="card-kpi-title">Média do colaborador</div>
        <div class="card-kpi-value text-primary" id="indMediaColaborador">--</div>
        <div class="small text-muted">
          <span class="badge badge-soft">Período selecionado</span>
        </div>
      </div>
    </div>
  </div>
  <div class="col-md-4 mb-3">
    <div class="card card-kpi">
      <div class="card-body">
        <div class="card-kpi-title">Média do grupo</div>
        <div class="card-kpi-value text-primary" id="indMediaGrupo">--</div>
        <div class="small text-muted">
          Grupo atual do colaborador.
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Gráficos -->
<div class="row">
  <!-- Radar dimensões -->
  <div class="col-lg-6 mb-3">
    <div class="card">
      <div class="card-header py-2 d-flex justify-content-between align-items-center text-primary">
        <strong>Média por bloco</strong> <span class="small text-muted">(Colaborador x Grupo)</span>
      </div>
      <div class="card-body">
        <div class="chart-container-small">
          <canvas id="chartRadarDimensoes"></canvas>
        </div>
      </div>
    </div>
  </div>

  <!-- Evolução no tempo -->
  <div class="col-lg-6 mb-3">
    <div class="card">
      <div class="card-header py-2 d-flex justify-content-between align-items-center text-primary">
        <strong>Evolução no tempo</strong> <span class="small text-muted">(média por ciclo)</span>
      </div>
      <div class="card-body">
        <div class="chart-container-small">
          <canvas id="chartEvolucaoIndividual"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Tabela de detalhes (simplificada) -->
<div class="row">
  <div class="col-12 mb-3">
    <div class="card">
      <div class="card-header py-2 d-flex justify-content-between align-items-center bg-info text-white">
        <strong>Detalhes das avaliações</strong>
        <small class="text-white">Avaliações lançadas.</small>
      </div>
      <div class="card-body p-0">
        <div class="table-responsive">
          <table class="table table-sm table-striped mb-0" id="table_envios">
            <thead class="thead-light">
              <tr>
                <th class="text-center"></th>
                <th class="text-center">Data</th>
                <th class="text-left">Grupo</th>
                <th class="text-left">Formulário</th>
                <th class="text-center">Nota</th>
                <th class="text-left">Responsável</th>
              </tr>
            </thead>
            <tbody>
              <?php if (count($this->envios)) foreach ($this->envios as $envio): ?>
                <tr>
                  <td class="text-center px-2"><a class="btn btn-link" onclick="verEnvio(<?= $envio['id_envio'] ?>)"><i class="fa fa-eye"></i> Ver Respostas</a></td>
                  <td class="text-center px-2"><?= Util::formatData($envio['data_envio']) ?></td>
                  <td class="text-left px-2"><?= $envio['grupo'] ?></td>
                  <td class="text-left px-2"><?= $envio['formulario'] ?></td>
                  <td class="text-right px-4"><?= $envio['nota'] ?></td>
                  <td class="text-left px-2"><?= $envio['avaliador'] ?></td>
                </tr>
              <?php endforeach; ?>
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  $(function() {

    /* ========================= CHARTS – INSTÂNCIAS ========================= */

    var chartRadarDimensoes, chartEvolucaoIndividual;

    // Config padrão
    var chartOptionsBase = {
      legend: {
        display: true
      },
      responsive: true,
      maintainAspectRatio: false
    };

    function criarChartRadarDimensoes(dados) {
      var ctx = document.getElementById('chartRadarDimensoes').getContext('2d');
      chartRadarDimensoes = new Chart(ctx, {
        type: 'radar',
        data: {
          labels: dados.dimensoes.labels,
          datasets: [{
              label: 'Colaborador',
              data: dados.dimensoes.colab,
              backgroundColor: 'rgba(59,130,246,0.2)',
              borderColor: 'rgba(59,130,246,1)',
              pointBackgroundColor: 'rgba(59,130,246,1)'
            },
            {
              label: 'Grupo',
              data: dados.dimensoes.grupo,
              backgroundColor: 'rgba(16,185,129,0.2)',
              borderColor: 'rgba(16,185,129,1)',
              pointBackgroundColor: 'rgba(16,185,129,1)'
            }
          ]
        },
        options: $.extend(true, {}, chartOptionsBase, {
          scale: {
            ticks: {
              min: 0,
              max: 10,
              stepSize: 1
            }
          }
        })
      });
    }

    function criarChartEvolucaoIndividual(dados) {
      var ctx = document.getElementById('chartEvolucaoIndividual').getContext('2d');
      chartEvolucaoIndividual = new Chart(ctx, {
        type: 'line',
        data: {
          labels: dados.evolucao.labels,
          datasets: [{
            label: 'Média do colaborador',
            data: dados.evolucao.valores,
            fill: false,
            borderColor: 'rgba(234,88,12,1)',
            borderWidth: 2,
            pointRadius: 3
          }]
        },
        options: $.extend(true, {}, chartOptionsBase, {
          scales: {
            yAxes: [{
              ticks: {
                min: 0,
                max: 10,
                stepSize: 1
              }
            }]
          }
        })
      });
    }

    /* ======================== INDIVIDUAL – INICIALIZAÇÃO ======================== */

    function preencherCabecalhoIndividual(dados) {
      $('#indMediaColaborador').text(dados.mediaColab.toFixed(1));
      $('#indMediaGrupo').text(dados.mediaGrupo.toFixed(1));
    }

    function carregarDashboardIndividual() {
      var id = $('#filtroColaboradorIndividual').val();
      var dados = JSON.parse('<?= json_encode($this->estatistica) ?>');
      if (!dados) return;

      preencherCabecalhoIndividual(dados);

      // Destroi gráficos antigos se existirem
      if (chartRadarDimensoes) chartRadarDimensoes.destroy();
      if (chartEvolucaoIndividual) chartEvolucaoIndividual.destroy();

      criarChartRadarDimensoes(dados);
      criarChartEvolucaoIndividual(dados);
    }

    carregarDashboardIndividual();

  });

  function verEnvio(id_envio) {
    carregarTela('../../avaliacao/detalhe?id_envio=' + id_envio);
  }

  $(document).ready(function() {
    $('#table_envios').DataTable({
      language: {
        url: 'https://cdn.datatables.net/plug-ins/1.10.19/i18n/Portuguese-Brasil.json'
      },
      "columnDefs": [{
        type: "date-br",
        targets: [1]
      }, {
        orderable: false,
        targets: [0]
      }],
      "order": [
        [1, 'desc']
      ],
      paging: false,
      searching: false
    });
  });
</script>